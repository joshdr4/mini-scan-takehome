version: '3'
services:
  # DynamoDB Local for development
  dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: mini-scan-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb"

  # Initialize DynamoDB table
  init-table:
    image: amazon/aws-cli:latest
    depends_on:
      - dynamodb
    environment:
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
      AWS_DEFAULT_REGION: us-east-1
    restart: on-failure
    entrypoint: /bin/sh
    command: >
      -c "
      echo 'Waiting for DynamoDB to be ready...';
      sleep 3;
      aws dynamodb create-table
      --table-name scan-results
      --attribute-definitions AttributeName=pk,AttributeType=S
      --key-schema AttributeName=pk,KeyType=HASH
      --billing-mode PAY_PER_REQUEST
      --endpoint-url http://dynamodb:8000
      || echo 'Table already exists or creation failed'
      "
